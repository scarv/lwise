# Copyright (C) 2021 SCARV project <info@scarv.org>
#
# Use of this source code is restricted per the MIT license, a copy of which 
# can be found at https://opensource.org/licenses/MIT (or should be included 
# as LICENSE.txt within the associated archive or repository).

zbk_dir = ${REPO_HOME}/src/hw/verilator/verify/zbk

INC_DIRS  =-I$(EMU_HAL) -I$(zbk_dir)
SRCS = ${REPO_HOME}/src/hw/verilator/verify/$(ARCH)/verify.c \
       ${REPO_HOME}/src/hw/verilator/verify/$(ARCH)/rv64zbk.S \
       $(wildcard $(EMU_HAL)/*.c) \
       $(wildcard $(EMU_HAL)/*.S) \


VERIFY  = ${REPO_HOME}/build/emu_verify-${ARCH}.elf
DISASM  = ${REPO_HOME}/build/emu_verify-${ARCH}.disasm

$(VERIFY) : $(SRCS)
	${GCC_PREFIX}-gcc ${GCC_FLAGS} ${INC_DIRS} -std='gnu99' -O2 -o ${@} $(filter %.c, ${^}) $(filter %.S, ${^}) ${GCC_LIBS}
	
$(DISASM) : $(VERIFY)
	${GCC_PREFIX}-objdump --disassemble-all -Dt $< > $@

emulate-verify : ${EMULATOR} ${VERIFY} $(DISASM)
	${EMULATOR} -c -x 200000 -v ${REPO_HOME}/build/emu_verify-${ARCH}.vcd -m 2100000 ${VERIFY}
